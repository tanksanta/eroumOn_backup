<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="clcln">

	<resultMap type="ordrDtlVO" id="ordrDtlListVOMap" autoMapping="true">
		<collection property="ordrChgHist" 	column="{ordrNo=ordr_no, ordrDtlNo=ordr_dtl_no}" select="ordr.chg.selectOrdrChgHistListAll" />
		<collection property="bplcInfo" 	column="{srchUniqueId=bplc_unique_id}" select="partners.bplc.selectBplc" />
	</resultMap>

	<!-- Define OrdrVO Column List -->
	<sql id="listColumn">
		 o.ordr_no
		 , o.ordr_cd
		 , o.unique_id
		 , o.ordr_ty
		 , o.ordr_dt
		 , o.ordrr_id
		 , o.ordrr_nm
		 , o.ordrr_eml
		 , o.ordrr_telno
		 , o.ordrr_mbl_telno
		 , o.ordrr_zip
		 , o.ordrr_addr
		 , o.ordrr_daddr
		 , o.ordrr_memo
		 , o.recptr_nm
		 , o.recptr_telno
		 , o.recptr_mbl_telno
		 , o.recptr_zip
		 , o.recptr_addr
		 , o.recptr_daddr

		 , o.use_mlg
		 , o.use_point

		 , o.stlm_device
		 , o.stlm_ty
		 , o.stlm_amt
		 , o.stlm_yn
		 , o.stlm_dt

	     , o.delng_no

	     , o.billing_yn
	     , o.billing_key

	     , o.card_co_nm
	     , o.card_no
	     , o.card_aprvno
	     , o.card_prtc_yn

	     , o.vr_actno
	     , o.dpst_bank_cd
	     , o.dpst_bank_nm
	     , o.dpstr
	     , o.pyr_nm
	     , o.dpst_term_dt

		 , o.cashrcipt_yn
		 , o.cashrcipt_no

	</sql>

	<sql id="searchConditions">
		<if test="srchOrdrYmdBgng !=null and srchOrdrYmdBgng != ''">
			AND DATE_FORMAT(o.ordr_dt, '%Y-%m-%d') &gt;= #{srchOrdrYmdBgng}
		</if>
		<if test="srchOrdrYmdEnd !=null and srchOrdrYmdEnd != ''">
			AND DATE_FORMAT(o.ordr_dt, '%Y-%m-%d') &lt;= #{srchOrdrYmdEnd}
		</if>
		<if test="srchBplcUniqueId !=null and srchBplcUniqueId != ''">
			AND od.bplc_unique_id = #{srchBplcUniqueId}
		</if>
		<if test="srchBplcNm !=null and srchBplcNm != ''">
			AND b.bplc_nm LIKE CONCAT('%',#{srchBplcNm},'%')
		</if>
		<if test="srchEntrpsNm !=null and srchEntrpsNm != ''">
			AND od.entrps_nm LIKE CONCAT('%',#{srchEntrpsNm},'%')
		</if>
	</sql>

	<select id="selectOrdrList" parameterType="java.util.HashMap" resultMap="ordrDtlListVOMap">
		SELECT
			<include refid="listColumn"/>
			 , od.ordr_dtl_cd
			 , od.ordr_dtl_no
			 , od.gds_no
			 , od.gds_cd
			 , od.bnef_cd
			 , od.gds_nm
			 , od.gds_sup_pc
			 , od.gds_pc
			 , od.entrps_no
			 , od.entrps_nm
			 , od.gds_item_cd
			 , od.optn_item_cd
			 , od.ordr_pc
			 , od.ordr_optn_ty
			 , od.ordr_optn
			 , od.ordr_optn_pc
			 , od.ordr_qy
			 , od.accml_mlg
			 , od.coupon_no
			 , od.coupon_cd
			 , od.coupon_amt
			 , od.refund_aprvno
			 , NULLIF(od.recipter_unique_id, '') as recipter_unique_id
			 , NULLIF(od.bplc_unique_id, '') as bplc_unique_id
		 	 , od.stts_ty

		 	 , od.sndng_dt
			 , od.dlvy_ty
			 , od.dlvy_hope_ymd
			 , od.dlvy_stlm_ty
			 , od.dlvy_bass_amt
			 , od.dlvy_adit_amt
			 , od.dlvy_stts
			 , od.dlvy_co_no
			 , od.dlvy_co_nm
			 , od.dlvy_dt
			 , od.dlvy_invc_no

		 	 , od.rfnd_yn
			 , od.rfnd_bank
			 , od.rfnd_actno
			 , od.rfnd_amt
			 , od.rfnd_dt
			 , od.rfnd_dpstr
			 , od.reg_unique_id
			 , od.reg_dt
			 , od.reg_id
			 , od.rgtr
		FROM ORDR o LEFT JOIN ORDR_DTL od ON o.ordr_no = od.ordr_no
			WHERE od.stts_ty IN ('RE03', 'CA02', 'OR07', 'OR08', 'OR09')
			AND (SELECT COUNT(*) FROM ORDR_DTL od2 WHERE od2.ordr_cd = od.ordr_cd AND ordr_optn_ty = 'BASE' AND od2.stts_ty NOT IN ('EX03', 'RE03', 'CA02', 'OR07', 'OR08', 'OR09') ) &lt; 1
			<include refid="searchConditions" />
	  	ORDER BY o.ordr_no DESC, od.ordr_dtl_cd ASC, od.ordr_dtl_no ASC
	</select>
	<!-- AND o.ordr_ty = 'N'-->


	<select id="selectPartnerList" parameterType="java.util.HashMap" resultType="egovMap">
		SELECT
			od.bplc_unique_id, b.bplc_nm, COUNT(*) AS buy_cnt
			, SUM(od.dlvy_bass_amt) AS dlvy_bass_amt, SUM(od.dlvy_adit_amt) AS dlvy_adit_amt
			, SUM(od.ordr_pc + od.coupon_amt) AS ordr_pc
			, b.pic_nm, b.pic_telno, b.pic_eml
		FROM ORDR_DTL od LEFT JOIN ORDR o ON od.ordr_no = o.ordr_no
		 LEFT JOIN GDS g ON od.gds_no = g.gds_no
		 LEFT JOIN BPLC b ON od.bplc_unique_id = b.unique_id
		WHERE od.bplc_unique_id IS NOT NULL AND bplc_unique_id != ''
		  AND od.stts_ty IN ('RE03', 'CA02', 'OR07', 'OR08', 'OR09')
		  AND o.ordr_ty IN ('R', 'L')
		  AND (SELECT COUNT(*) FROM ORDR_DTL od2 WHERE od2.ordr_cd = od.ordr_cd AND ordr_optn_ty = 'BASE' AND od2.stts_ty NOT IN ('EX03', 'RE03', 'CA02', 'OR07', 'OR08', 'OR09') ) &lt; 1
		  <include refid="searchConditions" />
		GROUP BY od.bplc_unique_id
	</select>

</mapper>