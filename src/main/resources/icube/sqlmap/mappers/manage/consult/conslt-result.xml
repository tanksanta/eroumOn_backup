<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="conslt.result">

	<resultMap type="mbrConsltResultVO" id="mbrConsltResultVOMap" autoMapping="true" />

	<resultMap type="mbrConsltResultVO" id="mbrConsltResultListVOMap" autoMapping="true">
		<association property="mbrConsltInfo" column="{consltNo=conslt_no}" select="conslt.selectMbrConslt" />
	</resultMap>

	<sql id="listColumn">
		bplc_conslt_no
		, conslt_no
		, bplc_unique_id
		, bplc_id
		, bplc_nm
		, conslt_dtls
		, conslt_sttus
		, conslt_dt
		, reconslt_resn
		, reconslt_dt
	</sql>

	<sql id="searchConditions">
		<if test="srchConsltNo != null  and srchConsltNo != '' ">
			AND conslt_no = #{srchConsltNo}
		</if>
		<if test="srchBplcConsltNo != null  and srchBplcConsltNo != '' ">
			AND bplc_conslt_no = #{srchBplcConsltNo}
		</if>
		<if test="srchBplcUniqueId != null  and srchBplcUniqueId != '' ">
			AND bplc_unique_id = #{srchBplcUniqueId}
		</if>
		<if test="srchConsltSttus != null  and srchConsltSttus != '' ">
			AND conslt_sttus = #{srchConsltSttus}
		</if>

	</sql>

	<select id="selectMbrConsltResultListVO" parameterType="java.util.HashMap" resultMap="mbrConsltResultListVOMap">
		/* Query ID : conslt.selectMbrConsltListVO */
		SELECT
			<include refid="listColumn"/>
		FROM MBR_CONSLT_RESULT
		WHERE 1=1
			<include refid="searchConditions" />
	  	ORDER BY bplc_conslt_no DESC
	  	LIMIT #{startNum}, #{endNumMysql}
	</select>

	<select id="selectMbrConsltResultCount" parameterType="java.util.HashMap" resultType="int">
		SELECT COUNT(*)
			<include refid="listColumn" />
		FROM MBR_CONSLT_RESULT
		WHERE 1=1
			<include refid="searchConditions" />
	</select>


	<select id="selectMbrConsltResultList" parameterType="java.util.HashMap" resultMap="mbrConsltResultVOMap">
		SELECT
			<include refid="listColumn"/>
		FROM MBR_CONSLT_RESULT
		WHERE 1=1
			<include refid="searchConditions" />
	  	ORDER BY bplc_conslt_no ASC
	</select>

	<!-- 회원상담 사업소 지정 -->
	<insert id="insertMbrConsltBplc" parameterType="mbrConsltResultVO">
		INSERT INTO MBR_CONSLT_RESULT (
			conslt_no
			, bplc_unique_id
			, bplc_id
			, bplc_nm
			, conslt_sttus
			, reg_unique_id
		    , reg_dt
		    , reg_id
		    , rgtr
		)VALUES(
			#{consltNo}
			, #{bplcUniqueId}
			, #{bplcId}
			, #{bplcNm}
			, #{consltSttus}
			, #{regUniqueId}
		    , SYSDATE()
		    , #{regId}
		    , #{rgtr}
		)
	</insert>

	<!-- 상담완료 -->
	<update id="updateDtlsConslt" parameterType="mbrConsltResultVO">
		UPDATE MBR_CONSLT_RESULT SET
			conslt_dtls = #{consltDtls}
			, conslt_dt = SYSDATE()
			, conslt_sttus = 'CS06'
		WHERE bplc_conslt_no = #{bplcConsltNo}
	</update>


	<select id="selectMbrConsltBplc" parameterType="java.util.HashMap" resultMap="mbrConsltResultVOMap">
		SELECT
			<include refid="listColumn"/>
		FROM MBR_CONSLT_RESULT
		WHERE 1=1
			<include refid="searchConditions" />
		ORDER BY bplc_conslt_no DESC
		LIMIT 1
	</select>

	<!-- 상담취소 -->
	<update id="updateCanclConslt" parameterType="java.util.HashMap">
		UPDATE MBR_CONSLT_RESULT SET
			conslt_sttus = #{consltSttus}
		WHERE conslt_no = #{consltNo}
		  AND bplc_conslt_no = #{bplcConsltNo}
	</update>

	<!-- 상태변경 -->
	<update id="updateSttus" parameterType="java.util.HashMap">
		UPDATE MBR_CONSLT_RESULT SET
			conslt_sttus = #{consltSttus}
		WHERE conslt_no = #{consltNo}
		  AND bplc_conslt_no = #{bplcConsltNo}
	</update>

	<!-- 완료된건에 대해서 재상담 사유만 입력 -->
	<update id="updateReConslt" parameterType="mbrConsltResultVO">
		UPDATE MBR_CONSLT_RESULT SET
			reconslt_resn = #{reconsltResn}
			, reconslt_dt = SYSDATE()
		WHERE conslt_no = #{consltNo}
		  AND bplc_unique_Id = #{bplcUniqueId}
		  AND conslt_sttus = 'CS06'
	</update>

	<!-- 상담전 재배정 -->
	<delete id="deleteMbrConsltBplc" parameterType="mbrConsltResultVO">
		DELETE FROM MBR_CONSLT_RESULT
		WHERE conslt_no = #{consltNo}
		  AND conslt_sttus = #{consltSttus}
	</delete>

</mapper>