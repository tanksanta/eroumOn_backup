<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="conslt">

	<resultMap type="mbrConsltVO" id="mbrConsltVOMap" autoMapping="true">
		<collection property="consltResultList" column="{srchConsltNo=conslt_no}" select="conslt.result.selectMbrConsltResultList" />
	</resultMap>

	<sql id="listColumn">
		conslt_no
		, mbr_nm
		, mbr_telno
		, brdt
		, gender
		, zip
		, addr
		, daddr
		, use_yn
		, reg_unique_id
	    , reg_dt
	    , reg_id
	    , rgtr

	    , conslt_sttus
	    , sttus_chg_dt
	    , cancl_resn
	    , cancl_dt

	    , mng_memo
		, memo_mdfcn_dt
		, mngr_unique_id
		, mngr_id
		, mngr_nm
	</sql>

	<sql id="searchConditions">
		<choose>
			<when test="srchRegBgng != null and srchRegBgng != '' and srchRegEnd != null and srchRegEnd != '' ">
				AND DATE_FORMAT(reg_dt,'%Y-%m-%d') &gt;= #{srchRegBgng} AND DATE_FORMAT(reg_dt,'%Y-%m-%d') &lt;= #{srchRegEnd}
			</when>
			<when test= 'srchRegBgng != null and srchRegBgng != "" '>
				AND DATE_FORMAT(reg_dt,'%Y-%m-%d') &gt;= #{srchRegBgng}
			</when>
			<when test='srchRegEnd != null and srchRegEnd != "" '>
				AND DATE_FORMAT(reg_dt,'%Y-%m-%d') &lt;= #{srchRegEnd}
			</when>
		</choose>
		<if test="srchUniqueId != null and srchUniqueId != '' ">
			AND reg_unique_id = #{srchUniqueId}
		</if>
		<if test="srchMbrNm != null and srchMbrNm != '' ">
			AND mbr_nm like CONCAT ('%',#{srchMbrNm},'%')
		</if>
		<if test="srchMbrTelno != null  and srchMbrTelno != '' ">
			AND mbr_telno like CONCAT ('%',#{srchMbrTelno},'%')
		</if>
		<if test="srchUseYn != null and srchUseYn != '' ">
			AND use_yn = #{srchUseYn}
		</if>
		<if test="srchConsltSttus != null and srchConsltSttus != '' ">
			AND conslt_sttus = #{srchConsltSttus}
		</if>
	</sql>

	<select id="selectMbrConsltListVO" parameterType="java.util.HashMap" resultMap="mbrConsltVOMap">
		/* Query ID : conslt.selectMbrConsltListVO */
		SELECT
			<include refid="listColumn"/>
		FROM MBR_CONSLT
		WHERE 1=1
			<include refid="searchConditions" />
	  	ORDER BY conslt_no DESC
	  	LIMIT #{startNum}, #{endNumMysql}
	</select>

	<select id="selectMbrConsltCount" parameterType="java.util.HashMap" resultType="int">
		SELECT COUNT(*)
			<include refid="listColumn" />
		FROM MBR_CONSLT
		WHERE 1=1
			<include refid="searchConditions" />
	</select>

	<update id="updateUseYn" parameterType="java.util.HashMap">
		UPDATE MBR_CONSLT SET
			use_yn = #{useYn}
		WHERE conslt_no = #{consltNo}
	</update>

	<select id="selectMbrConslt" parameterType="java.util.HashMap" resultMap="mbrConsltVOMap">
		SELECT
			<include refid="listColumn" />
		FROM MBR_CONSLT
		WHERE conslt_no = #{consltNo}
			<include refid="searchConditions" />
	</select>

	<insert id="insertMbrConslt" parameterType="mbrConsltVO">
		INSERT INTO MBR_CONSLT(
			mbr_nm
			, mbr_telno
			, brdt
			, gender
			, zip
			, addr
			, daddr
			, use_yn
			, reg_unique_id
		    , reg_dt
		    , reg_id
		    , rgtr
		    , conslt_sttus
		)VALUES(
			#{mbrNm}
			, #{mbrTelno}
			, #{brdt}
			, #{gender}
			, #{zip}
			, #{addr}
			, #{daddr}
			, #{useYn}
			, #{regUniqueId}
		    , SYSDATE()
		    , #{regId}
		    , #{rgtr}
		    , 'CS01'
		)
	</insert>

	<!-- 관리자 메모 + 사업소 지정시 상태변경 처리 -->
	<update id="updateMbrConslt" parameterType="mbrConsltVO">
		UPDATE MBR_CONSLT SET
			mng_memo = #{mngMemo}
			, memo_mdfcn_dt = SYSDATE()
			, mngr_unique_id = #{mngrUniqueId}
			, mngr_id = #{mngrId}
			, mngr_nm = #{mngrNm}
			<if test="consltSttus != null and consltSttus != ''">
			, conslt_sttus = #{consltSttus}
			, sttus_chg_dt = SYSDATE()
			</if>
		WHERE conslt_no = #{consltNo}
	</update>

	<update id="updateCanclConslt" parameterType="java.util.HashMap">
		UPDATE MBR_CONSLT SET
			conslt_sttus = #{consltSttus}
			, cancl_resn = #{canclResn}
			, cancl_dt = SYSDATE()
		WHERE conslt_no = #{consltNo}
	</update>


	<update id="updateSttus" parameterType="java.util.HashMap">
		UPDATE MBR_CONSLT SET
			conslt_sttus = #{consltSttus}
		WHERE conslt_no = #{consltNo}
	</update>

</mapper>