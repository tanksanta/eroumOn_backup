<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="conslt">

	<resultMap type="mbrConsltVO" id="mbrConsltVOMap" autoMapping="true">
		<collection property="consltResultList" column="{srchConsltNo=conslt_no}" select="conslt.result.selectMbrConsltResultList" />
	</resultMap>

	<sql id="listColumn">
		conslt_no
		, mbr_nm
		, mbr_telno
		, brdt
		, gender
		, zip
		, addr
		, daddr
		, use_yn
		, reg_unique_id
	    , reg_dt
	    , reg_id
	    , rgtr

	    , conslt_sttus
	    , sttus_chg_dt
	    , cancl_resn
	    , cancl_dt

	    , mng_memo
		, memo_mdfcn_dt
		, mngr_unique_id
		, mngr_id
		, mngr_nm

		, re_conslt_dt
	</sql>

	<sql id="searchConditions">
		<choose>
			<when test="srchRegBgng != null and srchRegBgng != '' and srchRegEnd != null and srchRegEnd != '' ">
				AND DATE_FORMAT(reg_dt,'%Y-%m-%d') &gt;= #{srchRegBgng} AND DATE_FORMAT(reg_dt,'%Y-%m-%d') &lt;= #{srchRegEnd}
			</when>
			<when test= 'srchRegBgng != null and srchRegBgng != "" '>
				AND DATE_FORMAT(reg_dt,'%Y-%m-%d') &gt;= #{srchRegBgng}
			</when>
			<when test='srchRegEnd != null and srchRegEnd != "" '>
				AND DATE_FORMAT(reg_dt,'%Y-%m-%d') &lt;= #{srchRegEnd}
			</when>
		</choose>
		<if test="srchUniqueId != null and srchUniqueId != '' ">
			AND reg_unique_id = #{srchUniqueId}
		</if>
		<if test="srchMbrNm != null and srchMbrNm != '' ">
			AND mbr_nm like CONCAT ('%',#{srchMbrNm},'%')
		</if>
		<if test="srchMbrTelno != null  and srchMbrTelno != '' ">
			AND mbr_telno like CONCAT ('%',#{srchMbrTelno},'%')
		</if>
		<if test="srchUseYn != null and srchUseYn != '' ">
			AND use_yn = #{srchUseYn}
		</if>
		<if test="srchConsltSttus != null and srchConsltSttus != '' ">
			<choose>
				<when test="srchConsltSttus == 'CANCEL' ">
			AND conslt_sttus IN ('CS03', 'CS04', 'CS09')
				</when>
				<otherwise>
			AND conslt_sttus = #{srchConsltSttus}
				</otherwise>
			</choose>
		</if>

		<!-- 사업소명 검색 & 취소건(화면x) 제외 -->
		<if test="srchBplcNm != null and srchBplcNm != '' ">
		 	AND conslt_no IN (SELECT conslt_no FROM MBR_CONSLT_RESULT mcr WHERE mcr.conslt_no = mc.conslt_no AND mcr.bplc_nm LIKE CONCAT ('%',#{srchBplcNm},'%'))
		 	AND conslt_sttus NOT IN ('CS03', 'CS04', 'CS09')
		</if>
	</sql>

	<select id="selectMbrConsltListVO" parameterType="java.util.HashMap" resultMap="mbrConsltVOMap">
		/* Query ID : conslt.selectMbrConsltListVO */
		SELECT
			<include refid="listColumn"/>,
			CASE 
				WHEN mc.RE_CONSLT_DT IS NULL THEN mc.REG_DT
                WHEN mc.RE_CONSLT_DT > mc.REG_DT THEN mc.RE_CONSLT_DT
                ELSE mc.RE_CONSLT_DT
			END AS cur_conslt_dt
		FROM MBR_CONSLT mc
		WHERE 1=1
			<include refid="searchConditions" />
	  	ORDER BY cur_conslt_dt DESC
	  	LIMIT #{startNum}, #{endNumMysql}
	</select>

	<select id="selectMbrConsltCount" parameterType="java.util.HashMap" resultType="int">
		SELECT COUNT(*)
			<include refid="listColumn" />
		FROM MBR_CONSLT mc
		WHERE 1=1
			<include refid="searchConditions" />
	</select>

	<update id="updateUseYn" parameterType="java.util.HashMap">
		UPDATE MBR_CONSLT SET
			use_yn = #{useYn}
		WHERE conslt_no = #{consltNo}
	</update>

	<select id="selectMbrConslt" parameterType="java.util.HashMap" resultMap="mbrConsltVOMap">
		SELECT
			<include refid="listColumn" />
		FROM MBR_CONSLT mc
		WHERE conslt_no = #{consltNo}
			<include refid="searchConditions" />
	</select>
	
	<insert id="insertMbrConslt" parameterType="mbrConsltVO">
		INSERT INTO MBR_CONSLT(
			mbr_nm
			, mbr_telno
			, brdt
			, gender
			, zip
			, addr
			, daddr
			, use_yn
			, reg_unique_id
		    , reg_dt
		    , reg_id
		    , rgtr
		    , conslt_sttus
		    , recipients_no
		    , relation_cd
		    , rcper_rcogn_no
		    , prev_path
		)VALUES(
			#{mbrNm}
			, #{mbrTelno}
			, #{brdt}
			, #{gender}
			, #{zip}
			, #{addr}
			, #{daddr}
			, #{useYn}
			, #{regUniqueId}
		    , SYSDATE()
		    , #{regId}
		    , #{rgtr}
		    , 'CS01'
		    , #{recipientsNo}
		    , #{relationCd}
		    , #{rcperRcognNo}
		    , #{prevPath}
		)
	</insert>

	<!-- 관리자 메모 + 사업소 지정시 상태변경 처리 -->
	<update id="updateMbrConslt" parameterType="mbrConsltVO">
		UPDATE MBR_CONSLT SET
			mng_memo = #{mngMemo}
			, memo_mdfcn_dt = SYSDATE()
			, mngr_unique_id = #{mngrUniqueId}
			, mngr_id = #{mngrId}
			, mngr_nm = #{mngrNm}
			<if test="consltSttus != null and consltSttus != ''">
			, conslt_sttus = #{consltSttus}
			, sttus_chg_dt = SYSDATE()
			</if>
		WHERE conslt_no = #{consltNo}
	</update>

	<update id="updateCanclConslt" parameterType="java.util.HashMap">
		UPDATE MBR_CONSLT SET
			conslt_sttus = #{consltSttus}
			, cancl_resn = #{canclResn}
			, cancl_dt = SYSDATE()
		WHERE conslt_no = #{consltNo}
	</update>

	<update id="updateMngMemo" parameterType="java.util.HashMap">
		UPDATE MBR_CONSLT SET
			mng_memo = #{mngMemo}
		WHERE conslt_no = #{consltNo}
	</update>

	<update id="updateSttus" parameterType="java.util.HashMap">
		UPDATE MBR_CONSLT SET
			conslt_sttus = #{consltSttus}
			<if test="consltSttus == 'CS07'">
			, re_conslt_dt = SYSDATE()
			</if>
		WHERE conslt_no = #{consltNo}
	</update>


	<select id="selectListForExcel" parameterType="java.util.HashMap" resultMap="mbrConsltVOMap">
		SELECT
			<include refid="listColumn"/>
		FROM MBR_CONSLT mc
		WHERE 1=1
			<include refid="searchConditions" />
	  	ORDER BY conslt_no DESC
	</select>
	
	<!-- 생성 직후 신청한 상담 조회용 -->
	<select id="selectLastMbrConsltForCreate" parameterType="java.util.HashMap" resultType="mbrConsltVO">
		SELECT
			<include refid="listColumn" />
		FROM MBR_CONSLT mc
		WHERE rgtr = #{srchRgtr}
		  AND reg_unique_id = #{srchUniqueId}
		ORDER BY conslt_no DESC
		LIMIT 1;
	</select>

	<!-- 회원 탈퇴 전 검사용으로 진행중인 상담이 있는지 조회 -->
	<select id="selectConsltInProcess" parameterType="java.util.HashMap" resultType="mbrConsltVO">
		SELECT
			<include refid="listColumn" />
		FROM MBR_CONSLT mc
		WHERE reg_unique_id = #{srchUniqueId}
		  AND conslt_sttus IN ('CS01', 'CS02', 'CS05', 'CS07', 'CS08')
		LIMIT 1;
	</select>
</mapper>