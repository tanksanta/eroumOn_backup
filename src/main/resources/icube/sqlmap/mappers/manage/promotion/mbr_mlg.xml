<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mbr.mlg">

	<!-- Define MbrMlgVO Result Map  -->
	<resultMap type="mbrMlgVO" id="mbrMlgVOMap" autoMapping="true" >
		<!-- 대상 회원 --><collection property="mbrList" column="srchUniqueId=unique_id" select="mbr.selectMbr" />
	</resultMap>

	<resultMap type="mbrMlgVO" id="mbrMlgListVOMap" autoMapping="true"  />


	<!-- Define MbrMlgVO Column List -->
	<sql id="listColumn">
		mlg.mlg_no
		, mlg.mlg_mng_no
		, mlg.unique_id
		, mlg.ordr_cd
		, mlg.ordr_dtl_cd
		, mlg.mlg_se
		, mlg.mlg_cn
		, mlg.mlg
		, mlg.use_mlg
		, mlg.mlg_acmtl
		, mlg.give_mthd
		, mlg.reg_unique_id
		, mlg.reg_dt
		<if test="srchRegDt != null and srchRegDt != '' ">
		, DATE_FORMAT(mlg.reg_dt,'%Y-12-31 11:59:00') AS fmt_dt
		</if>
		, mlg.reg_id
		, mlg.rgtr
	</sql>

	<sql id="searchConditions">
		<choose>
			<when test="srchBgngDt != null and srchBgngDt != '' and srchEndDt != null and srchEndDt != '' ">
				AND DATE_ADD(mlg.reg_dt, INTERVAL #{srchRegDt} YEAR) &gt;= #{srchBgngDt} AND DATE_ADD(mlg.reg_dt, INTERVAL #{srchRegDt} YEAR) &lt;= #{srchEndDt}
			</when>
			<when test= 'srchBgngDt != null and srchBgngDt != "" '>
				AND DATE_ADD(mlg.reg_dt, INTERVAL #{srchRegDt} YEAR) &gt;= #{srchBgngDt}
			</when>
			<when test='srchEndDt != null and srchEndDt != "" '>
				AND DATE_ADD(mlg.reg_dt, INTERVAL #{srchRegDt} YEAR) &lt;= #{srchEndDt}
			</when>
		</choose>

		<if test="srchMlgMngNo != null and srchMlgMngNo != '' ">
			AND mlg.mlg_mng_no = #{srchMlgMngNo}
		</if>
		<if test="srchUniqueId != null and srchUniqueId != '' ">
			AND mlg.unique_id = #{srchUniqueId}
		</if>
		<if test="srchMlgSe != null and srchMlgSe != '' ">
			AND mlg.mlg_se = #{srchMlgSe}
		</if>
		<if test="srchMlgCn != null and srchMlgCn != '' ">
			AND mlg.mlg_cn = #{srchMlgCn}
		</if>
		<if test="srchMngrMemo != null and srchMngrMemo != '' ">
			AND mng.mngr_memo like CONCAT('%',#{srchMngrMemo},'%')
		</if>
		<if test="srchOrdrCd != null and srchOrdrCd != '' ">
			AND mlg.ordr_cd = #{srchOrdrCd}
		</if>
		<if test="srchOrdrDtlCd != null and srchOrdrDtlCd != '' ">
			AND mlg.ordr_dtl_cd = #{srchOrdrDtlCd}
		</if>
		<if test="srchTwoYear != null and srchTwoYear != '' ">
			AND DATEDIFF(NOW(),reg_dt) &gt;= 730
		</if>
		<if test="srchTwoYearBeforeWeek != null and srchTwoYearBeforeWeek != '' ">
			AND DATEDIFF(NOW(),reg_dt) &gt;= 723
		</if>
	</sql>

	<select id="selectMbrMlgListVO" parameterType="java.util.HashMap" resultMap="mbrMlgVOMap">
		/* Query ID : mbrMlg.selectMbrMlgListVO */
		SELECT
			<include refid="listColumn"/>
			, mng.mngr_memo
		FROM MBR_MLG mlg
		LEFT JOIN MLG_MNG mng ON mlg.mlg_mng_no = mng.mlg_mng_no
		WHERE 1=1
			<include refid="searchConditions" />
	  	ORDER BY mlg.mlg_no DESC
	  	LIMIT #{startNum}, #{endNumMysql}
	</select>

	<select id="selectMbrMlgCount" parameterType="java.util.HashMap" resultType="int">
		/* Query ID : mbrMlg.selectMbrMlgCount */
		SELECT	COUNT(*)
		FROM	MBR_MLG mlg
		LEFT JOIN MLG_MNG mng ON mlg.mlg_mng_no = mng.mlg_mng_no
		WHERE	1=1
			<include refid="searchConditions"/>
	</select>

	<select id="selectMbrMlg" parameterType="java.util.HashMap" resultType="mbrMlgVO">
		/* Query ID : mbrMlg.selectMbrMlg */
		SELECT
			<include refid="listColumn"/>
		FROM	MBR_MLG mlg
		WHERE  1=1
		 	<include refid="searchConditions" />
		 ORDER BY mlg_no DESC
		 LIMIT 1
	</select>

	<!--  마일리지 종합 -->
	<select id="selectAlltypeMlg" parameterType="java.util.HashMap" resultType="egovMap">
		SELECT
			IFNULL((SELECT SUM(mlg) FROM MBR_MLG mlg WHERE mlg_se = "A" <include refid="searchConditions" /> ),0) AS add_mlg
			, IFNULL((SELECT SUM(mlg) FROM MBR_MLG mlg WHERE mlg_se = "M" <include refid="searchConditions" />),0) AS use_mlg
			, IFNULL((SELECT SUM(mlg) FROM MBR_MLG mlg WHERE mlg_se = "E" <include refid="searchConditions" />),0) AS ext_mlg
			, IFNULL((SELECT mlg_acmtl FROM MBR_MLG mlg WHERE unique_id = #{srchUniqueId} ORDER BY mlg_no DESC LIMIT 1 ),0) AS own_mlg
	</select>

	<select id="selectMbrMlgList" parameterType="java.util.HashMap" resultMap="mbrMlgVOMap">
		/* Query ID : mbrMlg.selectMbrMlgList */
		SELECT
			<include refid="listColumn" />
			, mng.mngr_memo
		FROM MBR_MLG mlg
		LEFT JOIN MLG_MNG mng ON mlg.mlg_mng_no = mng.mlg_mng_no
		WHERE 1=1
			<include refid="searchConditions" />
		ORDER BY mlg_no DESC
	</select>

	<!-- 마일리지 적립,차감 -->
	<insert id="insertMbrMlg" parameterType="mbrMlgVO">
		/* Query ID : mbrMlg.insertMbrMlg */
		INSERT INTO MBR_MLG (
			 unique_id
			 , mlg_mng_no
			 , ordr_cd
			 , ordr_dtl_cd
			 , mlg_se
			 , mlg_cn
			 , mlg
			 , use_mlg
			 , mlg_acmtl
			 , give_mthd
			 , reg_unique_id
			 , reg_dt
			 , reg_id
			 , rgtr
		) VALUES (
			#{uniqueId, jdbcType=VARCHAR}
			, #{mlgMngNo}
			, #{ordrCd, jdbcType=VARCHAR}
			, #{ordrDtlCd, jdbcType=VARCHAR}
			, #{mlgSe, jdbcType=VARCHAR}
			, #{mlgCn, jdbcType=VARCHAR}
			, #{mlg}
			, 0
			<if test='mlgSe != null and mlgSe == "A" '>
			, IFNULL((SELECT mlg_acmtl FROM MBR_MLG mm WHERE mm.unique_id = #{uniqueId} ORDER BY mlg_no DESC LIMIT 1), 0) + #{mlg}
			</if>
			<if test='mlgSe != null and mlgSe == "M" '>
			, IFNULL((SELECT mlg_acmtl FROM MBR_MLG mm WHERE mm.unique_id = #{uniqueId} ORDER BY mlg_no DESC LIMIT 1), 0) - #{mlg}
			</if>
			, #{giveMthd, jdbcType=VARCHAR}
			, #{regUniqueId, jdbcType=VARCHAR}
			, SYSDATE()
			, #{regId, jdbcType=VARCHAR}
			, #{rgtr, jdbcType=VARCHAR}
		)
	</insert>

	<!-- 마일리지 소멸 -->
	<insert id="extinctMbrMlg" parameterType="mbrMlgVO">
		INSERT INTO MBR_MLG (
			 mlg_mng_no
			 , unique_id
			 , mlg_se
			 , mlg_cn
			 , mlg
			 , mlg_acmtl
			 , give_mthd
			 , rgtr
			 , reg_dt
		) VALUES (
			#{mlgMngNo}
			, #{uniqueId, jdbcType=VARCHAR}
			, #{mlgSe, jdbcType=VARCHAR}
			, #{mlgCn, jdbcType=VARCHAR}
			, #{mlg}
			, #{mlgAcmtl}
			, #{giveMthd, jdbcType=VARCHAR}
			, #{rgtr, jdbcType=VARCHAR}
			, SYSDATE()
		)
	</insert>


</mapper>