<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mbr.point">

	<!-- Define MbrPointVO Result Map  -->
	<resultMap type="mbrPointVO" id="mbrPointVOMap" autoMapping="true" >
		<!-- 대상 회원 --><collection property="mbrList" column="srchUniqueId=unique_id" select="mbr.selectMbr" />
	</resultMap>

	<resultMap type="mbrPointVO" id="pointListVOMap" autoMapping="true"  />

	<!-- Define MbrPointVO Column List -->
	<sql id="listColumn">
		p.point_no
		, p.point_mng_no
		, p.unique_id
		, p.ordr_cd
		, p.ordr_dtl_cd
		, p.point_se
		, p.point_cn
		, p.point
		, p.point_acmtl
		, p.give_mthd
		, p.reg_unique_id
		, p.reg_dt
		<if test="srchRegDt != null and srchRegDt != '' ">
		, DATE_FORMAT(p.reg_dt,'%Y-12-31 11:59:00') AS fmt_dt
		</if>
		, p.reg_id
		, p.rgtr
	</sql>

	<!-- Define Search Condition -->
	<sql id="searchConditions">
		<choose>
			<when test="srchBgngDt != null and srchBgngDt != '' and srchEndDt != null and srchEndDt != '' ">
				AND p.reg_dt &gt;= #{srchBgngDt} AND p.reg_dt &lt;= #{srchEndDt}
			</when>
			<when test= 'srchBgngDt != null and srchBgngDt != "" '>
				AND p.reg_dt &gt;= #{srchBgngDt}
			</when>
			<when test='srchEndDt != null and srchEndDt != "" '>
				AND p.reg_dt &lt;= #{srchEndDt}
			</when>
		</choose>
		<if test="srchPointMngNo != null and srchPointMngNo != '' ">
			AND p.point_mng_no = #{srchPointMngNo}
		</if>
		<if test="srchUniqueId != null and srchUniqueId != '' ">
			AND unique_id = #{srchUniqueId}
		</if>
		<if test="srchMngrMemo != null and srchMngrMemo != '' ">
			AND mng.mngr_memo like CONCAT ('%',#{srchMngrMemo},'%')
		</if>
		<if test="srchPointSe != null and srchPointSe != '' ">
			AND p.point_se = #{srchPointSe}
		</if>
		<if test="srchPointCn != null and srchPointCn != '' ">
			AND p.point_cn = #{srchPointCn}
		</if>
		<if test="srchOrdrCd != null and srchOrdrCd != '' ">
			AND ordr_cd = #{srchOrdrCd}
		</if>
		<if test="srchOrdrDtlCd != null and srchOrdrDtlCd != '' ">
			AND ordr_dtl_cd = #{srchOrdrDtlCd}
		</if>
		<if test="srchNowYear != null and srchNowYear != '' ">
			AND YEAR(reg_dt) = YEAR(NOW())-1
		</if>

		<!-- 리스트업 sort -->
		<if test="srchSortBy != null and srchSortBy != '' ">
			AND point_se = #{srchSortBy}
		</if>

	</sql>

	<!-- Define point_acmtl List Query -->
	<select id="selectMbrPointListVO" parameterType="java.util.HashMap" resultMap="mbrPointVOMap">
		/* Query ID : mbrPoint.selectMbrPointListVO */
		SELECT
			<include refid="listColumn"/>
			, mng.mngr_memo
		FROM MBR_POINT p
		LEFT JOIN POINT_MNG mng ON p.point_mng_no = mng.point_mng_no
		WHERE 1=1
			<include refid="searchConditions" />
	  	ORDER BY p.point_no DESC
	  	LIMIT #{startNum}, #{endNumMysql}
	</select>

	<!-- Define point_acmtl Count Query -->
	<select id="selectMbrPointCount" parameterType="java.util.HashMap" resultType="int">
		/* Query ID : mbrPoint.selectMbrPointCount */
		SELECT	COUNT(*)
		FROM	MBR_POINT p
		LEFT JOIN POINT_MNG mng ON p.point_mng_no = mng.point_mng_no
		WHERE	1=1
			<include refid="searchConditions"/>
	</select>

	<!-- Define point_acmtl Detail Query -->
	<!-- 	LEFT JOIN POINT_MNG mng ON p.point_mng_no = mng.point_mng_no -->
	<select id="selectMbrPoint" parameterType="java.util.HashMap" resultMap="mbrPointVOMap">
		/* Query ID : mbrPoint.selectMbrPoint */
		SELECT
			<include refid="listColumn"/>
		FROM MBR_POINT p
		WHERE  1=1
			<include refid="searchConditions" />
		ORDER BY point_no DESC
		LIMIT 1
	</select>

	<select id="selectMbrPointList" parameterType="java.util.HashMap" resultMap="mbrPointVOMap">
		/* Query ID : pointMng.selectPointMng */
		SELECT
			<include refid="listColumn"/>
			, mng.mngr_memo
		FROM MBR_POINT p
		LEFT JOIN POINT_MNG mng ON p.point_mng_no = mng.point_mng_no
		WHERE	1=1
			<include refid="searchConditions" />
		ORDER BY point_no DESC
	</select>

	<!-- 포인트 종합 -->
	<select id="selectAlltypePoint" parameterType="java.util.HashMap" resultType="egovMap">
		SELECT
			IFNULL((SELECT SUM(point) FROM MBR_POINT WHERE point_se = "A" <include refid="searchConditions" />),0) AS add_point
			, IFNULL((SELECT SUM(point) FROM MBR_POINT WHERE point_se = "M" <include refid="searchConditions" />),0) AS use_point
			, IFNULL((SELECT SUM(point) FROM MBR_POINT WHERE point_se = "E" <include refid="searchConditions" />),0) AS ext_point
			, IFNULL((SELECT point_acmtl FROM MBR_POINT WHERE unique_id = #{srchUniqueId} ORDER BY point_no DESC LIMIT 1 ),0) AS own_point
	</select>
	
	<!-- 소멸예정 포인트 조회 -->
	<select id="selectExtinctPoinThisYear" parameterType="java.util.HashMap" resultMap="mbrPointVOMap">
		/* Query ID : mbrPoint.selectExtinctPoinThisYear */
		SELECT * FROM MBR_POINT
		WHERE point_no IN (
			SELECT MAX(point_no) FROM MBR_POINT 
		    WHERE reg_dt &gt;= CONCAT(DATE_FORMAT(now(),'%Y'), '-01-01 00:00:00') 
			  AND reg_dt &lt;= CONCAT(DATE_FORMAT(now(),'%Y'), '-12-31 23:59:59')
		    GROUP BY unique_id
		);
	</select>
	

	<!-- 포인트 적립, 차감 -->
	<insert id="insertMbrPoint" parameterType="mbrPointVO">
	/* Query ID : mbrPoint.insertMbrPoint */
	INSERT INTO MBR_POINT (
		point_mng_no
		, unique_id
		, ordr_cd
		, ordr_dtl_cd
		, point_se
		, point_cn
		, point
		, point_acmtl
		, give_mthd
		, reg_unique_id
		, reg_dt
		, reg_id
		, rgtr
	) VALUES (
		#{pointMngNo}
		, #{uniqueId, jdbcType=VARCHAR}
		, #{ordrCd, jdbcType=VARCHAR}
		, #{ordrDtlCd, jdbcType=VARCHAR}
		, #{pointSe, jdbcType=VARCHAR}
		, #{pointCn, jdbcType=VARCHAR}
		, #{point}
		<if test='pointSe != null and pointSe == "A" '>
		, IFNULL((SELECT point_acmtl FROM MBR_POINT mp WHERE mp.unique_id = #{uniqueId} ORDER BY point_no DESC LIMIT 1), 0) + #{point}
		</if>
		<if test='pointSe != null and pointSe == "M" '>
		, IFNULL((SELECT point_acmtl FROM MBR_POINT mp WHERE mp.unique_id = #{uniqueId} ORDER BY point_no DESC LIMIT 1), 0) - #{point}
		</if>
		, #{giveMthd, jdbcType=VARCHAR}
		, #{regUniqueId, jdbcType=VARCHAR}
		, SYSDATE()
		, #{regId, jdbcType=VARCHAR}
		, #{rgtr, jdbcType=VARCHAR}
		)
	</insert>

	<!-- 포인트 소멸 -->
	<insert id="extinctMbrPoint" parameterType="mbrPointVO">
		INSERT INTO MBR_POINT(
			point_mng_no
			, unique_id
			, point_se
			, point_cn
			, point
			, point_acmtl
			, give_mthd
			, rgtr
			, reg_dt
		)VALUES(
			#{pointMngNo}
			, #{uniqueId, jdbcType=VARCHAR}
			, #{pointSe, jdbcType=VARCHAR}
			, #{pointCn, jdbcType=VARCHAR}
			, #{point}
			, #{pointAcmtl}
			, #{giveMthd, jdbcType=VARCHAR}
			, #{rgtr, jdbcType=VARCHAR}
			, SYSDATE()
		)

	</insert>

</mapper>